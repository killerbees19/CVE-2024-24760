# Ursache für die externe Erreichbarkeit

Zuerst einmal natürlich `net.ipv4.ip_forward=1`, aber das ist bekanntermaßen für Docker zwingend notwendig. :-)

Die wirkliche Ursache liegt in diesen Firewallregeln:

```
  root@mailcow:~# iptables -nvL FORWARD
  Chain FORWARD (policy DROP 0 packets, 0 bytes)
   pkts bytes target     prot opt in     out     source               destination
  ...
      0     0 DOCKER     0    --  *      br-mailcow  0.0.0.0/0            0.0.0.0/0
  ...

  root@mailcow:~# iptables -nvL DOCKER
  Chain DOCKER (2 references)
   pkts bytes target     prot opt in     out     source               destination
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.253         tcp dpt:587
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.x           tcp dpt:443
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.x           tcp dpt:3306
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:12345
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:4190
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.249         tcp dpt:6379
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.x           tcp dpt:8983
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.253         tcp dpt:465
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.x           tcp dpt:80
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:995
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.253         tcp dpt:25
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:993
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:143
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:110
```

Besonders interessant sind hierbei folgende vier Zeilen:

```
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.x           tcp dpt:3306
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:12345
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.250         tcp dpt:6379
      0     0 ACCEPT     6    --  !br-mailcow br-mailcow  0.0.0.0/0            172.22.1.x           tcp dpt:8983
```

Das sind vier Ports, die laut `docker-compose.yml` eigentlich nur auf __localhost__ freigegeben werden sollten:

```
  - "${SQL_PORT:-127.0.0.1:13306}:3306"
  - "${DOVEADM_PORT:-127.0.0.1:19991}:12345"
  - "${REDIS_PORT:-127.0.0.1:7654}:6379"
  - "${SOLR_PORT:-127.0.0.1:18983}:8983"
```

Dennoch existieren die gleichen ACCEPT-Regeln, die in der FORWARD-Kette zur Anwendung kommen! Das führt dazu, dass die Pakete des Angreifers durchgelassen werden und NICHT nur jene Pakete, die über das DNAT kommen. Die Limitierung auf 127.0.0.1 in der NAT-Tabelle wird somit komplett umgangen.

## Weiterführende Links

Nach einer kurzen Recherche scheint das ein generelles Docker-Problem zu sein, das bereits seit mehreren Jahren bekannt ist. Die prominenteste Meldung dazu ist wohl…

* GitHub Gist: [Permissive forwarding rule leads to unintentional exposure of containers to external hosts](https://gist.github.com/1dc1742dce690eb560a3a2d7581a9632)
* Hacker News: [Permissive forwarding rule leads to unintentional exposure of containers (2021) (gist.github.com)](https://news.ycombinator.com/item?id=31839936)

Und zahlreiche weitere Issues zu dieser Problematik bei Docker.
